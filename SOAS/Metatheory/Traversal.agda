
open import SOAS.Common
open import SOAS.Families.Core
open import Categories.Object.Initial
open import SOAS.Coalgebraic.Strength
import SOAS.Metatheory.MetaAlgebra
import SOAS.Context

-- Traversals parametrised by a pointed coalgebra
module SOAS.Metatheory.Traversal {T : Set}
  (open SOAS.Context {T})
  ([_]_ : Ctx â†’ T â†’ T)
  (â…€F : Functor ğ”½amiliesâ‚› ğ”½amiliesâ‚›) (â…€:Str : Strength â…€F)
  (open SOAS.Metatheory.MetaAlgebra [_]_ â…€F)
  (ğ•‹:Init : Initial ğ•„etaAlgebras)
  where

open import SOAS.Variable
open import SOAS.Abstract.Hom
import SOAS.Abstract.Coalgebra as â†’â–¡ ; open â†’â–¡.Sorted
import SOAS.Abstract.Box as â–¡ ; open â–¡.Sorted

open import SOAS.Metatheory.Algebra â…€F
open import SOAS.Metatheory.Contextual [_]_
open import SOAS.Metatheory.Semantics [_]_ â…€F â…€:Str ğ•‹:Init

open Strength â…€:Str

private
  variable
    Î“ Î” Î˜ Î  Î¨ : Ctx
    Î± Î² : T
    ğ“Ÿ ğ“  ğ“ : Familyâ‚‚


-- Parametrised interpretation into an internal hom
module Traversal (ğ“Ÿá´® : {ğ” : MCtx} â†’ Coalgâ‚š (ğ“Ÿ ğ”))
                 (ğ‘ğ‘™ğ‘” : (â…€ Â²) ğ“ â‡¾Ì£â‚‚ ğ“)
                 (Ï† : ğ“Ÿ â‡¾Ì£â‚‚ ğ“)
                 (Ï‡ : âˆ¥_âˆ¥ â‡¾Ì£â‚‚ ã€– ğ“ , ğ“ ã€—Â²)
                 (ğ‘ğ‘œğ‘¥ : {Î¨ : Ctx} â†’ (K Î¨ Â²) ğ“ â‡¾Ì£â‚‚ (Î´box Î¨ Â²) ğ“)
  private
    open module - {ğ”} = Coalgâ‚š (ğ“Ÿá´® {ğ”})

  -- Under the assumptions ğ“ and ã€– ğ“Ÿ , ğ“ ã€— are both meta-algebras
  ğ“áµƒ : MetaAlg ğ“
  ğ“áµƒ = record { ğ‘ğ‘™ğ‘” = ğ‘ğ‘™ğ‘” ; ğ‘£ğ‘ğ‘Ÿ = Î» x â†’ Ï† (Î· x) ; ğ‘šğ‘£ğ‘ğ‘Ÿ = Ï‡ ; ğ‘ğ‘œğ‘¥ = ğ‘ğ‘œğ‘¥ }

  Traváµƒ : MetaAlg ã€– ğ“Ÿ , ğ“ ã€—Â²
  Traváµƒ = record
    { ğ‘ğ‘™ğ‘”  = Î» {ğ”} t Ïƒ â†’ ğ‘ğ‘™ğ‘” (str ğ“Ÿá´® (ğ“ ğ”) t Ïƒ)
    ; ğ‘£ğ‘ğ‘Ÿ  = Î» x Ïƒ â†’ Ï† (Ïƒ x)
    ; ğ‘šğ‘£ğ‘ğ‘Ÿ = Î» ğ”ª Îµ Ïƒ â†’ Ï‡ ğ”ª (Î» ğ”« â†’ Îµ ğ”« Ïƒ)
    ; ğ‘ğ‘œğ‘¥ = Î» t Ïƒ â†’ ğ‘ğ‘œğ‘¥ (t Î·)
    }

  -- ã€– ğ“Ÿ , ğ“ ã€— is also a pointed â–¡-coalgebra
  Traváµ‡ : {ğ” : MCtx} â†’ Coalg (ã€– ğ“Ÿ , ğ“ ã€—Â² ğ”)
  Traváµ‡ = record { r = Î» h Ï Ïƒ â†’ h (Ïƒ âˆ˜ Ï) ; counit = refl ; comult = refl }

  Travá´® : {ğ” : MCtx} â†’ Coalgâ‚š (ã€– ğ“Ÿ , ğ“ ã€—Â² ğ”)
  Travá´® = record { áµ‡ = Traváµ‡ ; Î· = Î» x Ïƒ â†’ Ï† (Ïƒ x) ; râˆ˜Î· = refl }

  open Semantics Traváµƒ public renaming (ğ•¤ğ•–ğ• to ğ•¥ğ•£ğ•’ğ•§)

  -- Traversal-specific homomorphism properties that incorporate a substitution
  ğ•¥âŸ¨ğ•§âŸ© : {ğ” : MCtx}{Ïƒ : Î“ ~[ ğ“Ÿ ğ” ]â† Î”}{x : â„ Î± Î“} â†’ ğ•¥ğ•£ğ•’ğ•§ (ğ•§ğ•’ğ•£ x) Ïƒ â‰¡ Ï† (Ïƒ x)
  ğ•¥âŸ¨ğ•§âŸ© {Ïƒ = Ïƒ} = cong (Î» - â†’ - Ïƒ) âŸ¨ğ•§âŸ©

  ğ•¥âŸ¨ğ•âŸ© : {ğ” : MCtx}{Ïƒ : Î“ ~[ ğ“Ÿ ğ” ]â† Î”}{ğ”ª : Î  âŠ© Î± âˆˆ ğ”}{Îµ : Î  ~[ ğ•‹ ğ” ]â† Î“}
       â†’ ğ•¥ğ•£ğ•’ğ•§ (ğ•ğ•§ğ•’ğ•£ ğ”ª Îµ) Ïƒ â‰¡ Ï‡ ğ”ª (Î» p â†’ ğ•¥ğ•£ğ•’ğ•§ (Îµ p) Ïƒ)
  ğ•¥âŸ¨ğ•âŸ© {Ïƒ = Ïƒ} = cong (Î» - â†’ - Ïƒ) âŸ¨ğ•âŸ©

  ğ•¥âŸ¨ğ•’âŸ© : {ğ” : MCtx}{Ïƒ : Î“ ~[ ğ“Ÿ ğ” ]â† Î”}{t : â…€ (ğ•‹ ğ”) Î± Î“}
       â†’ ğ•¥ğ•£ğ•’ğ•§ (ğ•’ğ•ğ•˜ t) Ïƒ â‰¡ ğ‘ğ‘™ğ‘” (str ğ“Ÿá´® (ğ“ ğ”) (â…€â‚ ğ•¥ğ•£ğ•’ğ•§ t) Ïƒ)
  ğ•¥âŸ¨ğ•’âŸ© {Ïƒ = Ïƒ} = cong (Î» - â†’ - Ïƒ) âŸ¨ğ•’âŸ©

  ğ•¥âŸ¨ğ•“âŸ© : {ğ” : MCtx}{Ïƒ : Î“ ~[ ğ“Ÿ ğ” ]â† Î”}{b : K Î¨ (ğ•‹ ğ”) Î± Î“}
        â†’ ğ•¥ğ•£ğ•’ğ•§ (ğ•“ğ• ğ•© b) Ïƒ â‰¡ ğ‘ğ‘œğ‘¥ (ğ•¥ğ•£ğ•’ğ•§ b Î·)
  ğ•¥âŸ¨ğ•“âŸ© {Ïƒ = Ïƒ} = cong (Î» - â†’ - Ïƒ) âŸ¨ğ•“âŸ©

  -- Congruence in the two arguments of ğ•¥ğ•£ğ•’ğ•§
  ğ•¥â‰ˆâ‚ : {ğ” : MCtx}{Ïƒ : Î“ ~[ ğ“Ÿ ğ” ]â† Î”}{tâ‚ tâ‚‚ : ğ•‹ ğ” Î± Î“} â†’ tâ‚ â‰¡ tâ‚‚ â†’ ğ•¥ğ•£ğ•’ğ•§ tâ‚ Ïƒ â‰¡ ğ•¥ğ•£ğ•’ğ•§ tâ‚‚ Ïƒ
  ğ•¥â‰ˆâ‚ {Ïƒ = Ïƒ} p = cong (Î» - â†’ ğ•¥ğ•£ğ•’ğ•§ - Ïƒ) p

  ğ•¥â‰ˆâ‚‚ : {ğ” : MCtx}{Ïƒâ‚ Ïƒâ‚‚ : Î“ ~[ ğ“Ÿ ğ” ]â† Î”}{t : ğ•‹ ğ” Î± Î“}
      â†’ ({Ï„ : T}{x : â„ Ï„ Î“} â†’ Ïƒâ‚ x â‰¡ Ïƒâ‚‚ x)
      â†’ ğ•¥ğ•£ğ•’ğ•§ t Ïƒâ‚ â‰¡ ğ•¥ğ•£ğ•’ğ•§ t Ïƒâ‚‚
  ğ•¥â‰ˆâ‚‚ {t = t} p = cong (ğ•¥ğ•£ğ•’ğ•§ t) (dextâ€² p)


-- A pointed meta-Î›-algebra induces ğ•’ğ•ğ•˜ traversal into â–¡ ğ“
module â–¡Traversal {ğ“} (ğ“áµƒ : MetaAlg ğ“) =
  Traversal â„á´® (MetaAlg.ğ‘ğ‘™ğ‘” ğ“áµƒ) (MetaAlg.ğ‘£ğ‘ğ‘Ÿ ğ“áµƒ) (MetaAlg.ğ‘šğ‘£ğ‘ğ‘Ÿ ğ“áµƒ) (MetaAlg.ğ‘ğ‘œğ‘¥ ğ“áµƒ)

-- Corollary: â–¡ lifts to an endofunctor on pointed meta-Î›-algebras
â–¡áµƒ : (ğ“áµƒ : MetaAlg ğ“) â†’ MetaAlg ((â–¡ Â²) ğ“)
â–¡áµƒ = â–¡Traversal.Traváµƒ

-- Helper records for proving equality of maps f, g out of ğ•‹,
-- with 0, 1 or 2 parameters
record MapEqâ‚€ (ğ“ : Familyâ‚‚)(f g : ğ•‹ â‡¾Ì£â‚‚ ğ“) : Set where
  field
    áµƒ : MetaAlg ğ“
  open Semantics áµƒ
  open ğ“

  field
    fâŸ¨ğ‘£âŸ© : {ğ” : MCtx}{x : â„ Î± Î“}
         â†’ f (ğ•§ğ•’ğ•£ x) â‰¡ ğ‘£ğ‘ğ‘Ÿ {ğ”} x
    fâŸ¨ğ‘šâŸ© : {ğ” : MCtx}{ğ”ª : Î  âŠ© Î± âˆˆ ğ”}{Îµ : Î  ~[ ğ•‹ ğ” ]â† Î“}
         â†’ f (ğ•ğ•§ğ•’ğ•£ ğ”ª Îµ) â‰¡ ğ‘šğ‘£ğ‘ğ‘Ÿ ğ”ª (f âˆ˜ Îµ)
    fâŸ¨ğ‘âŸ© : {ğ” : MCtx}{t : â…€ (ğ•‹ ğ”) Î± Î“}
         â†’ f (ğ•’ğ•ğ•˜ t) â‰¡ ğ‘ğ‘™ğ‘” (â…€â‚ f t)
    fâŸ¨ğ‘âŸ© : {ğ” : MCtx}{b : K Î¨ (ğ•‹ ğ”) Î± Î“}
         â†’ f (ğ•“ğ• ğ•© b) â‰¡ ğ‘ğ‘œğ‘¥ {Î“ = Î“} (f b)
    gâŸ¨ğ‘£âŸ© : {ğ” : MCtx}{x : â„ Î± Î“}
         â†’ g (ğ•§ğ•’ğ•£ x) â‰¡ ğ‘£ğ‘ğ‘Ÿ {ğ”} x
    gâŸ¨ğ‘šâŸ© : {ğ” : MCtx}{ğ”ª : Î  âŠ© Î± âˆˆ ğ”}{Îµ : Î  ~[ ğ•‹ ğ” ]â† Î“}
         â†’ g (ğ•ğ•§ğ•’ğ•£ ğ”ª Îµ) â‰¡ ğ‘šğ‘£ğ‘ğ‘Ÿ ğ”ª (g âˆ˜ Îµ)
    gâŸ¨ğ‘âŸ© : {ğ” : MCtx}{t : â…€ (ğ•‹ ğ”) Î± Î“}
         â†’ g (ğ•’ğ•ğ•˜ t) â‰¡ ğ‘ğ‘™ğ‘” (â…€â‚ g t)
    gâŸ¨ğ‘âŸ© : {ğ” : MCtx}{b : K Î¨ (ğ•‹ ğ”) Î± Î“}
         â†’ g (ğ•“ğ• ğ•© b) â‰¡ ğ‘ğ‘œğ‘¥ {Î“ = Î“} (g b)

  fáµƒ : MetaAlgâ‡’ ğ•‹áµƒ áµƒ f
  fáµƒ = record { âŸ¨ğ‘ğ‘™ğ‘”âŸ© =  fâŸ¨ğ‘âŸ© ; âŸ¨ğ‘£ğ‘ğ‘ŸâŸ© =  fâŸ¨ğ‘£âŸ© ; âŸ¨ğ‘šğ‘£ğ‘ğ‘ŸâŸ© =  fâŸ¨ğ‘šâŸ© ; âŸ¨ğ‘ğ‘œğ‘¥âŸ© = fâŸ¨ğ‘âŸ© }
  gáµƒ : MetaAlgâ‡’ ğ•‹áµƒ áµƒ g
  gáµƒ = record { âŸ¨ğ‘ğ‘™ğ‘”âŸ© =  gâŸ¨ğ‘âŸ© ; âŸ¨ğ‘£ğ‘ğ‘ŸâŸ© =  gâŸ¨ğ‘£âŸ© ; âŸ¨ğ‘šğ‘£ğ‘ğ‘ŸâŸ© =  gâŸ¨ğ‘šâŸ© ; âŸ¨ğ‘ğ‘œğ‘¥âŸ© = gâŸ¨ğ‘âŸ© }

  â‰ˆ : {ğ” : MCtx}(t : ğ•‹ ğ” Î± Î“) â†’ f t â‰¡ g t
  â‰ˆ t = eq fáµƒ gáµƒ t

record MapEqâ‚ (ğ“Ÿá´® : {ğ” : MCtx} â†’ Coalgâ‚š (ğ“Ÿ ğ”))
              (ğ‘ğ‘™ğ‘” : (â…€ Â²) ğ“ â‡¾Ì£â‚‚ ğ“)
              (ğ‘ğ‘œğ‘¥ : {Î¨ : Ctx} â†’ (K Î¨ Â²) ğ“ â‡¾Ì£â‚‚ (Î´box Î¨ Â²) ğ“)
              (f g : ğ•‹ â‡¾Ì£â‚‚ ã€– ğ“Ÿ , ğ“ ã€—Â²) : Set where
  field
    Ï† : ğ“Ÿ â‡¾Ì£â‚‚ ğ“
    Ï‡ : âˆ¥_âˆ¥ â‡¾Ì£â‚‚ ã€– ğ“ , ğ“ ã€—Â²

  open Traversal ğ“Ÿá´® ğ‘ğ‘™ğ‘” Ï† Ï‡ ğ‘ğ‘œğ‘¥

  private
    open module - {ğ”} = Coalgâ‚š (ğ“Ÿá´® {ğ”})

  field
    fâŸ¨ğ‘£âŸ© : {ğ” : MCtx}{Ïƒ : Î“ ~[ ğ“Ÿ ğ” ]â† Î”}{x : â„ Î± Î“}
         â†’ f (ğ•§ğ•’ğ•£ x) Ïƒ â‰¡ Ï† (Ïƒ x)
    fâŸ¨ğ‘šâŸ© : {ğ” : MCtx}{Ïƒ : Î“ ~[ ğ“Ÿ ğ” ]â† Î”}{ğ”ª : Î  âŠ© Î± âˆˆ ğ”}{Îµ : Î  ~[ ğ•‹ ğ” ]â† Î“}
         â†’ f (ğ•ğ•§ğ•’ğ•£ ğ”ª Îµ) Ïƒ â‰¡ Ï‡ ğ”ª (Î» p â†’ f (Îµ p) Ïƒ)
    fâŸ¨ğ‘âŸ© : {ğ” : MCtx}{Ïƒ : Î“ ~[ ğ“Ÿ ğ” ]â† Î”}{t : â…€ (ğ•‹ ğ”) Î± Î“}
         â†’ f (ğ•’ğ•ğ•˜ t) Ïƒ â‰¡ ğ‘ğ‘™ğ‘” (str ğ“Ÿá´® (ğ“ ğ”) (â…€â‚ f t) Ïƒ)
    fâŸ¨ğ‘âŸ© : {ğ” : MCtx}{Ïƒ : Î“ ~[ ğ“Ÿ ğ” ]â† Î”}{b : K Î¨ (ğ•‹ ğ”) Î± Î“}
         â†’ f (ğ•“ğ• ğ•© b) Ïƒ â‰¡ ğ‘ğ‘œğ‘¥ (f b Î·)
    gâŸ¨ğ‘£âŸ© : {ğ” : MCtx}{Ïƒ : Î“ ~[ ğ“Ÿ ğ” ]â† Î”}{x : â„ Î± Î“}
         â†’ g (ğ•§ğ•’ğ•£ x) Ïƒ â‰¡ Ï† (Ïƒ x)
    gâŸ¨ğ‘šâŸ© : {ğ” : MCtx}{Ïƒ : Î“ ~[ ğ“Ÿ ğ” ]â† Î”}{ğ”ª : Î  âŠ© Î± âˆˆ ğ”}{Îµ : Î  ~[ ğ•‹ ğ” ]â† Î“}
         â†’ g (ğ•ğ•§ğ•’ğ•£ ğ”ª Îµ) Ïƒ â‰¡ Ï‡ ğ”ª (Î» p â†’ g (Îµ p) Ïƒ)
    gâŸ¨ğ‘âŸ© : {ğ” : MCtx}{Ïƒ : Î“ ~[ ğ“Ÿ ğ” ]â† Î”}{t : â…€ (ğ•‹ ğ”) Î± Î“}
         â†’ g (ğ•’ğ•ğ•˜ t) Ïƒ â‰¡ ğ‘ğ‘™ğ‘” (str ğ“Ÿá´® (ğ“ ğ”) (â…€â‚ g t) Ïƒ)
    gâŸ¨ğ‘âŸ© : {ğ” : MCtx}{Ïƒ : Î“ ~[ ğ“Ÿ ğ” ]â† Î”}{b : K Î¨ (ğ•‹ ğ”) Î± Î“}
         â†’ g (ğ•“ğ• ğ•© b) Ïƒ â‰¡ ğ‘ğ‘œğ‘¥ (g b Î·)

  fáµƒ : MetaAlgâ‡’ ğ•‹áµƒ Traváµƒ f
  fáµƒ = record { âŸ¨ğ‘ğ‘™ğ‘”âŸ© = dextâ€² fâŸ¨ğ‘âŸ© ; âŸ¨ğ‘£ğ‘ğ‘ŸâŸ© = dextâ€² fâŸ¨ğ‘£âŸ© ; âŸ¨ğ‘šğ‘£ğ‘ğ‘ŸâŸ© = dextâ€² fâŸ¨ğ‘šâŸ© ; âŸ¨ğ‘ğ‘œğ‘¥âŸ© = dextâ€² fâŸ¨ğ‘âŸ© }
  gáµƒ : MetaAlgâ‡’ ğ•‹áµƒ Traváµƒ g
  gáµƒ = record { âŸ¨ğ‘ğ‘™ğ‘”âŸ© = dextâ€² gâŸ¨ğ‘âŸ© ; âŸ¨ğ‘£ğ‘ğ‘ŸâŸ© = dextâ€² gâŸ¨ğ‘£âŸ© ; âŸ¨ğ‘šğ‘£ğ‘ğ‘ŸâŸ© = dextâ€² gâŸ¨ğ‘šâŸ© ; âŸ¨ğ‘ğ‘œğ‘¥âŸ© = dextâ€² gâŸ¨ğ‘âŸ© }

  â‰ˆ : {ğ” : MCtx}{Ïƒ : Î“ ~[ ğ“Ÿ ğ” ]â† Î”}(t : ğ•‹ ğ” Î± Î“) â†’ f t Ïƒ â‰¡ g t Ïƒ
  â‰ˆ {Ïƒ = Ïƒ} t = cong (Î» - â†’ - Ïƒ) (eq fáµƒ gáµƒ t)

record MapEqâ‚‚ (ğ“Ÿá´® : {ğ” : MCtx} â†’ Coalgâ‚š (ğ“Ÿ ğ”))
              (ğ“ á´® : {ğ” : MCtx} â†’ Coalgâ‚š (ğ“  ğ”))
              (ğ‘ğ‘™ğ‘” : (â…€ Â²) ğ“ â‡¾Ì£â‚‚ ğ“)
              (ğ‘ğ‘œğ‘¥ : {Î¨ : Ctx} â†’ (K Î¨ Â²) ğ“ â‡¾Ì£â‚‚ (Î´box Î¨ Â²) ğ“)
              (f g : ğ•‹ â‡¾Ì£â‚‚ ã€– ğ“Ÿ , ã€– ğ“  , ğ“ ã€—Â² ã€—Â²) : Set where
  field
    Ï† : ğ“  â‡¾Ì£â‚‚ ğ“
    Ï• : ğ“Ÿ â‡¾Ì£â‚‚ ã€– ğ“  , ğ“ ã€—Â²
    Ï‡ : âˆ¥_âˆ¥ â‡¾Ì£â‚‚ ã€– ğ“ , ğ“ ã€—Â²

  private
    open module P {ğ”} = Coalgâ‚š (ğ“Ÿá´® {ğ”}) renaming (Î· to ğ“ŸÎ·)
    open module Q {ğ”} = Coalgâ‚š (ğ“ á´® {ğ”}) renaming (Î· to ğ“ Î·)

  open Traversal ğ“Ÿá´® (Traversal.ğ“.ğ‘ğ‘™ğ‘” ğ“ á´® ğ‘ğ‘™ğ‘” Ï† Ï‡ ğ‘ğ‘œğ‘¥) Ï• (Î» ğ”ª Îµ Ïƒ â†’ Ï‡ ğ”ª (Î» ğ”« â†’ Îµ ğ”« Ïƒ)) (Î» b Ïƒ â†’ ğ‘ğ‘œğ‘¥ (b ğ“ Î·))

  field
    fâŸ¨ğ‘£âŸ© : {ğ” : MCtx}{Ïƒ : Î“ ~[ ğ“Ÿ ğ” ]â† Î”}{Ï‚ : Î” ~[ ğ“  ğ” ]â† Î˜}{x : â„ Î± Î“}
         â†’ f (ğ•§ğ•’ğ•£ x) Ïƒ Ï‚ â‰¡ Ï• (Ïƒ x) Ï‚
    fâŸ¨ğ‘šâŸ© : {ğ” : MCtx}{Ïƒ : Î“ ~[ ğ“Ÿ ğ” ]â† Î”}{Ï‚ : Î” ~[ ğ“  ğ” ]â† Î˜}{ğ”ª : Î  âŠ© Î± âˆˆ ğ”}{Îµ : Î  ~[ ğ•‹ ğ” ]â† Î“}
         â†’ f (ğ•ğ•§ğ•’ğ•£ ğ”ª Îµ) Ïƒ Ï‚ â‰¡ Ï‡ ğ”ª (Î» ğ”« â†’ f (Îµ ğ”«) Ïƒ Ï‚)
    fâŸ¨ğ‘âŸ© : {ğ” : MCtx}{Ïƒ : Î“ ~[ ğ“Ÿ ğ” ]â† Î”}{Ï‚ : Î” ~[ ğ“  ğ” ]â† Î˜}{t : â…€ (ğ•‹ ğ”) Î± Î“}
         â†’ f (ğ•’ğ•ğ•˜ t) Ïƒ Ï‚ â‰¡ ğ‘ğ‘™ğ‘” (str ğ“ á´® (ğ“ ğ”) (str ğ“Ÿá´® (ã€– ğ“  , ğ“ ã€—Â² ğ”) (â…€â‚ f t) Ïƒ) Ï‚)
    fâŸ¨ğ‘âŸ© : {ğ” : MCtx}{Ïƒ : Î“ ~[ ğ“Ÿ ğ” ]â† Î”}{Ï‚ : Î” ~[ ğ“  ğ” ]â† Î˜}{b : K Î¨ (ğ•‹ ğ”) Î± Î“}
         â†’ f (ğ•“ğ• ğ•© b) Ïƒ Ï‚ â‰¡ ğ‘ğ‘œğ‘¥ (f b ğ“ŸÎ· ğ“ Î·)
    gâŸ¨ğ‘£âŸ© : {ğ” : MCtx}{Ïƒ : Î“ ~[ ğ“Ÿ ğ” ]â† Î”}{Ï‚ : Î” ~[ ğ“  ğ” ]â† Î˜}{x : â„ Î± Î“}
         â†’ g (ğ•§ğ•’ğ•£ x) Ïƒ Ï‚ â‰¡ Ï• (Ïƒ x) Ï‚
    gâŸ¨ğ‘šâŸ© : {ğ” : MCtx}{Ïƒ : Î“ ~[ ğ“Ÿ ğ” ]â† Î”}{Ï‚ : Î” ~[ ğ“  ğ” ]â† Î˜}{ğ”ª : Î  âŠ© Î± âˆˆ ğ”}{Îµ : Î  ~[ ğ•‹ ğ” ]â† Î“}
         â†’ g (ğ•ğ•§ğ•’ğ•£ ğ”ª Îµ) Ïƒ Ï‚ â‰¡ Ï‡ ğ”ª (Î» ğ”« â†’ g (Îµ ğ”«) Ïƒ Ï‚)
    gâŸ¨ğ‘âŸ© : {ğ” : MCtx}{Ïƒ : Î“ ~[ ğ“Ÿ ğ” ]â† Î”}{Ï‚ : Î” ~[ ğ“  ğ” ]â† Î˜}{t : â…€ (ğ•‹ ğ”) Î± Î“}
         â†’ g (ğ•’ğ•ğ•˜ t) Ïƒ Ï‚ â‰¡ ğ‘ğ‘™ğ‘” (str ğ“ á´® (ğ“ ğ”) (str ğ“Ÿá´® (ã€– ğ“  , ğ“ ã€—Â² ğ”) (â…€â‚ g t) Ïƒ) Ï‚)
    gâŸ¨ğ‘âŸ© : {ğ” : MCtx}{Ïƒ : Î“ ~[ ğ“Ÿ ğ” ]â† Î”}{Ï‚ : Î” ~[ ğ“  ğ” ]â† Î˜}{b : K Î¨ (ğ•‹ ğ”) Î± Î“}
         â†’ g (ğ•“ğ• ğ•© b) Ïƒ Ï‚ â‰¡ ğ‘ğ‘œğ‘¥ (g b ğ“ŸÎ· ğ“ Î·)

  fáµƒ : MetaAlgâ‡’ ğ•‹áµƒ Traváµƒ f
  fáµƒ = record { âŸ¨ğ‘ğ‘™ğ‘”âŸ© = dextâ€² (dextâ€² fâŸ¨ğ‘âŸ©) ; âŸ¨ğ‘£ğ‘ğ‘ŸâŸ© = dextâ€² (dextâ€² fâŸ¨ğ‘£âŸ©)
              ; âŸ¨ğ‘šğ‘£ğ‘ğ‘ŸâŸ© = dextâ€² (dextâ€² fâŸ¨ğ‘šâŸ©) ; âŸ¨ğ‘ğ‘œğ‘¥âŸ© = dextâ€² (dextâ€² fâŸ¨ğ‘âŸ©) }
  gáµƒ : MetaAlgâ‡’ ğ•‹áµƒ Traváµƒ g
  gáµƒ = record { âŸ¨ğ‘ğ‘™ğ‘”âŸ© = dextâ€² (dextâ€² gâŸ¨ğ‘âŸ©) ; âŸ¨ğ‘£ğ‘ğ‘ŸâŸ© = dextâ€² (dextâ€² gâŸ¨ğ‘£âŸ©)
              ; âŸ¨ğ‘šğ‘£ğ‘ğ‘ŸâŸ© = dextâ€² (dextâ€² gâŸ¨ğ‘šâŸ©) ; âŸ¨ğ‘ğ‘œğ‘¥âŸ© = dextâ€² (dextâ€² gâŸ¨ğ‘âŸ©) }

  â‰ˆ : {ğ” : MCtx}{Ïƒ : Î“ ~[ ğ“Ÿ ğ” ]â† Î”}{Ï‚ : Î” ~[ ğ“  ğ” ]â† Î˜}(t : ğ•‹ ğ” Î± Î“) â†’ f t Ïƒ Ï‚ â‰¡ g t Ïƒ Ï‚
  â‰ˆ {Ïƒ = Ïƒ}{Ï‚} t = cong (Î» - â†’ - Ïƒ Ï‚) (eq fáµƒ gáµƒ t)

-- Interaction of traversal and interpretation
module _ (ğ“Ÿá´® : {ğ” : MCtx} â†’ Coalgâ‚š (ğ“Ÿ ğ”))(ğ“áµƒ : MetaAlg ğ“)(Ï† : ğ“Ÿ â‡¾Ì£â‚‚ ğ“) where
  open MetaAlg ğ“áµƒ
  private
    open module - {ğ”} = Coalgâ‚š (ğ“Ÿá´® {ğ”})
  open Semantics ğ“áµƒ
  open Traversal ğ“Ÿá´® ğ‘ğ‘™ğ‘” Ï† ğ‘šğ‘£ğ‘ğ‘Ÿ ğ‘ğ‘œğ‘¥ using (ğ•¥ğ•£ğ•’ğ•§ ; ğ•¥âŸ¨ğ•’âŸ© ; ğ•¥âŸ¨ğ•§âŸ© ; ğ•¥âŸ¨ğ•âŸ©; ğ•¥âŸ¨ğ•“âŸ©)
  open â‰¡-Reasoning

  -- Traversal with the point of ğ“Ÿ is the same as direct interpretation
  ğ•¥ğ•£ğ•’ğ•§-Î·â‰ˆğ•¤ğ•–ğ• : (Ï†âˆ˜Î·â‰ˆğ‘£ğ‘ğ‘Ÿ : âˆ€{Î± Î“ ğ”}{v : â„ Î± Î“} â†’ Ï† {ğ”} (Î· v) â‰¡ ğ‘£ğ‘ğ‘Ÿ v){ğ” : MCtx}{t : ğ•‹ ğ” Î± Î“}
        â†’ ğ•¥ğ•£ğ•’ğ•§ t Î· â‰¡ ğ•¤ğ•–ğ• t
  ğ•¥ğ•£ğ•’ğ•§-Î·â‰ˆğ•¤ğ•–ğ• Ï†âˆ˜Î·â‰ˆğ‘£ğ‘ğ‘Ÿ {t = t} = Semantics.eq ğ“áµƒ (record
    { âŸ¨ğ‘ğ‘™ğ‘”âŸ© = Î»{ {ğ”}{t = t} â†’ trans ğ•¥âŸ¨ğ•’âŸ© (cong ğ‘ğ‘™ğ‘” (begin
          str (ğ“Ÿá´® {ğ”}) (ğ“ ğ”) (â…€â‚ ğ•¥ğ•£ğ•’ğ•§ t) Î·
      â‰¡âŸ¨ str-natâ‚ (Î·á´®â‡’ (ğ“Ÿá´® {ğ”})) (â…€â‚ ğ•¥ğ•£ğ•’ğ•§ t) id âŸ©
          str â„á´® (ğ“ ğ”) (â…€â‚ (Î»{ h Ï â†’ h (Î· âˆ˜ Ï)}) ((â…€â‚ ğ•¥ğ•£ğ•’ğ•§ t))) id
      â‰¡âŸ¨ str-unit (ğ“ ğ”) ((â…€â‚ (Î»{ h Ï â†’ h (Î· âˆ˜ Ï)}) ((â…€â‚ ğ•¥ğ•£ğ•’ğ•§ t)))) âŸ©
          â…€â‚ (i (ğ“ ğ”)) (â…€â‚ (Î» { h Ï â†’ h (Î· âˆ˜ Ï) }) (â…€â‚ ğ•¥ğ•£ğ•’ğ•§ t))
      â‰¡Ë˜âŸ¨ trans â…€.homomorphism â…€.homomorphism âŸ©
          â…€â‚ (Î» t â†’ ğ•¥ğ•£ğ•’ğ•§ t Î·) t
      âˆ))}
    ; âŸ¨ğ‘£ğ‘ğ‘ŸâŸ© = Î»{ {v = v} â†’ trans ğ•¥âŸ¨ğ•§âŸ© Ï†âˆ˜Î·â‰ˆğ‘£ğ‘ğ‘Ÿ }
    ; âŸ¨ğ‘šğ‘£ğ‘ğ‘ŸâŸ© = Î»{ {ğ”ª}{Îµ} â†’ ğ•¥âŸ¨ğ•âŸ© }
    ; âŸ¨ğ‘ğ‘œğ‘¥âŸ© = ğ•¥âŸ¨ğ•“âŸ© }) ğ•¤ğ•–ğ•áµƒâ‡’ t

-- Traversal with the point of ğ“Ÿ into ğ•‹  is the identity
ğ•¥ğ•£ğ•’ğ•§-Î·â‰ˆid : (ğ“Ÿá´® : {ğ” : MCtx} â†’ Coalgâ‚š (ğ“Ÿ ğ”))(Ï† : ğ“Ÿ â‡¾Ì£â‚‚ ğ•‹)
            (Ï†âˆ˜Î·â‰ˆğ‘£ğ‘ğ‘Ÿ : âˆ€{Î± Î“ ğ”}{v : â„ Î± Î“}(open Coalgâ‚š (ğ“Ÿá´® {ğ”})) â†’ Ï† (Î· v) â‰¡ ğ•§ğ•’ğ•£ v)
            {ğ” : MCtx}{t : ğ•‹ ğ” Î± Î“}
            (open Coalgâ‚š (ğ“Ÿá´® {ğ”}))
          â†’ Traversal.ğ•¥ğ•£ğ•’ğ•§ ğ“Ÿá´® ğ•’ğ•ğ•˜ Ï† ğ•ğ•§ğ•’ğ•£ ğ•“ğ• ğ•© t Î· â‰¡ t
ğ•¥ğ•£ğ•’ğ•§-Î·â‰ˆid ğ“Ÿá´® Ï† Ï†âˆ˜Î·â‰ˆğ‘£ğ‘ğ‘Ÿ = trans (ğ•¥ğ•£ğ•’ğ•§-Î·â‰ˆğ•¤ğ•–ğ• ğ“Ÿá´® ğ•‹áµƒ Ï† Ï†âˆ˜Î·â‰ˆğ‘£ğ‘ğ‘Ÿ) ğ•¤ğ•–ğ•-id

-- Corollaries for â„-parametrised traversals
â–¡ğ•¥ğ•£ğ•’ğ•§-idâ‰ˆğ•¤ğ•–ğ• : (ğ“áµƒ : MetaAlgÂ ğ“){ğ” : MCtx}{t : ğ•‹ ğ” Î± Î“}
            â†’ â–¡Traversal.ğ•¥ğ•£ğ•’ğ•§ ğ“áµƒ t id â‰¡ Semantics.ğ•¤ğ•–ğ• ğ“áµƒ t
â–¡ğ•¥ğ•£ğ•’ğ•§-idâ‰ˆğ•¤ğ•–ğ• ğ“áµƒ {t} = ğ•¥ğ•£ğ•’ğ•§-Î·â‰ˆğ•¤ğ•–ğ• â„á´® ğ“áµƒ (MetaAlg.ğ‘£ğ‘ğ‘Ÿ ğ“áµƒ) refl

â–¡ğ•¥ğ•£ğ•’ğ•§-idâ‰ˆid : {ğ” : MCtx}{t : ğ•‹ ğ” Î± Î“} â†’ â–¡Traversal.ğ•¥ğ•£ğ•’ğ•§ ğ•‹áµƒ t id â‰¡ t
â–¡ğ•¥ğ•£ğ•’ğ•§-idâ‰ˆid = ğ•¥ğ•£ğ•’ğ•§-Î·â‰ˆid â„á´® ğ•§ğ•’ğ•£ refl
